<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序自定义下拉刷新和触底加载 | 胖吵吵的博客</title>
    <meta name="description" content="这是说明这是说明～～～">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.548d052b.css" as="style"><link rel="preload" href="/blog/assets/js/app.e0c79a37.js" as="script"><link rel="preload" href="/blog/assets/js/8.e146683d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.c8a8c376.js"><link rel="prefetch" href="/blog/assets/js/2.03bd4ed3.js"><link rel="prefetch" href="/blog/assets/js/3.bb05143b.js"><link rel="prefetch" href="/blog/assets/js/4.26d54acf.js"><link rel="prefetch" href="/blog/assets/js/5.d2eb2d75.js"><link rel="prefetch" href="/blog/assets/js/6.4f57c846.js"><link rel="prefetch" href="/blog/assets/js/7.6da16982.js"><link rel="prefetch" href="/blog/assets/js/9.1be3c9fa.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.548d052b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">胖吵吵的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/technique/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/blog/diary/" class="nav-link">随笔</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/technique/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/blog/diary/" class="nav-link">随笔</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>小程序</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/technique/weapp/issue.html" class="sidebar-link">小程序开发日记</a></li><li><a href="/blog/technique/weapp/custom-refresh.html" class="active sidebar-link">小程序自定义下拉刷新和触底加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/technique/weapp/custom-refresh.html#实现方式" class="sidebar-link">实现方式</a></li><li class="sidebar-sub-header"><a href="/blog/technique/weapp/custom-refresh.html#对比原生的下拉刷新" class="sidebar-link">对比原生的下拉刷新</a></li><li class="sidebar-sub-header"><a href="/blog/technique/weapp/custom-refresh.html#结语" class="sidebar-link">结语</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="小程序自定义下拉刷新和触底加载"><a href="#小程序自定义下拉刷新和触底加载" aria-hidden="true" class="header-anchor">#</a> 小程序自定义下拉刷新和触底加载</h1> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>在考虑实现自定义的下拉刷新组件的时候，首先要明确，这个算是一种hack方案。并不是说自定义的有多么好，反而自定义的下拉刷新在<code>android</code>下会有细微的卡顿（我这种实现方式）。所以尽量还是用小程序自带的吧。</p> <p>这个实现主要是参考<a href="https://www.cnblogs.com/aaronjs/p/9982708.html" target="_blank" rel="noopener noreferrer">艾伦大佬的组件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <h2 id="实现方式"><a href="#实现方式" aria-hidden="true" class="header-anchor">#</a> 实现方式</h2> <p>我们将页面分为下面的结构</p> <div style="width: 100%;font-size: 0;padding: 20px;background: #eee;border-radius: 3px;margin-top: 15px;display: flex;justify-content: space-around;flex-wrap: wrap;box-sizing: border-box;"><div><img src="/blog/imgs/refresh_view_1.png" alt="foo" style="width: 250px; margin: auto;display: block;"></div></div> <p>正常的时候<strong>下拉刷新区域</strong>的高度为<code>0</code>。</p> <p>然后我们通过<code>scroll-view</code>的<code>scrollToUpeper</code>事件来标记开始下滑。</p> <p>通过<code>touchstart</code>来记录我们手指的初始位置。</p> <p>通过监听<strong>列表区域</strong>的<code>touchmove</code>事件，来不断的计算手指移动距离。</p> <p><code>touchend</code>事件来触发更新事件。</p> <p>我们将页面分为几种状态：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">enum</span> refreshStatus <span class="token punctuation">{</span>
  <span class="token constant">INIT</span><span class="token punctuation">,</span>
  <span class="token constant">PULL_DOWN</span><span class="token punctuation">,</span>
  <span class="token constant">READY_REFRESH</span><span class="token punctuation">,</span>
  <span class="token constant">LOADING</span><span class="token punctuation">,</span>
  <span class="token constant">DONE</span>
<span class="token punctuation">}</span>
</code></pre></div><p>大致流程如下：</p> <ol><li><p>页面加载之后是<code>INIT</code>状态。</p></li> <li><p>当触发了<code>scroll-view</code>的<code>scrollToUpeper</code>事件，我们记录一个标志位<code>isUpper</code>，在<code>scroll-view</code>的<code>scroll</code>事件触发时，<code>isUpper</code>记为<code>false</code></p></li> <li><p>当我们列表页滑倒顶部的时候再下拉，页面进入了<code>PULL_DOWN</code>状态。 一般会设置一个有效的下拉距离，称之为<code>validHeight</code>，当下拉的高度不足<code>validHeight</code>时，这时候松开手指，页面回弹不刷新。</p></li> <li><p>当我们继续下拉，距离超过了<code>validHeight</code>这时候进入了<code>READY_REFRESH</code>状态。</p></li> <li><p>在<code>READY_REFRESH</code>状态的时候放开手指，页面刷新，进入<code>LOADING</code>状态。</p></li> <li><p>页面刷新完毕之后，进入<code>DONE</code>状态，刷新区域高度变为<code>0</code></p></li></ol> <p>我们还需要设置一个最大下拉高度，以及在<code>READY_REFRESH</code>状态，手指放开后回弹到刷新区域的最大高度。</p> <p>至此我们可以写出<code>touchend</code>、<code>touchstart</code>、<code>touchmove</code> 代码大致如下：（<a href="https://github.com/ChaosXu2016/blog-mini" target="_blank" rel="noopener noreferrer">详细代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>  <span class="token function">handleTouchMove</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> curTouch <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> moveY <span class="token operator">=</span> <span class="token punctuation">(</span>curTouch<span class="token punctuation">.</span>pageY <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTouchY<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.3</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isUpper <span class="token operator">||</span>
      moveY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> 
      moveY <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxHeight <span class="token operator">||</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>refreshStatu <span class="token operator">===</span> refreshStatus<span class="token punctuation">.</span><span class="token constant">LOADING</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>moveY <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>validHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        refreshHeight<span class="token punctuation">:</span> moveY<span class="token punctuation">,</span>
        refreshStatu<span class="token punctuation">:</span> refreshStatus<span class="token punctuation">.</span><span class="token constant">PULL_DOWN</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        refreshHeight<span class="token punctuation">:</span> moveY<span class="token punctuation">,</span>
        refreshStatu<span class="token punctuation">:</span> refreshStatus<span class="token punctuation">.</span><span class="token constant">READY_REFRESH</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleTouchStart</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> curTouch <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastTouchY <span class="token operator">=</span> curTouch<span class="token punctuation">.</span>pageY
  <span class="token punctuation">}</span>
  <span class="token function">handleTouchEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastTouchY <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>refreshStatu <span class="token operator">===</span> refreshStatus<span class="token punctuation">.</span><span class="token constant">READY_REFRESH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        refreshStatu<span class="token punctuation">:</span> refreshStatus<span class="token punctuation">.</span><span class="token constant">LOADING</span><span class="token punctuation">,</span>
        refreshHeight<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxHeight
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>onRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        refreshHeight<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleScrollToUpeper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isUpper <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isUpper <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>除此之外，我们还需要在调用的页面上加上<code>disableScroll: true</code>的配置，以解决ios整个页面跟着下滑的问题。</p> <h2 id="对比原生的下拉刷新"><a href="#对比原生的下拉刷新" aria-hidden="true" class="header-anchor">#</a> 对比原生的下拉刷新</h2> <ol><li><p>android下会有稍微的卡顿，ios和模拟器体验比较好。</p></li> <li><p>可以页面局部的下拉刷新。刷新的样式也可以定制化。</p></li></ol> <h2 id="结语"><a href="#结语" aria-hidden="true" class="header-anchor">#</a> 结语</h2> <p>其实在<code>ios</code>下还有一种实现方式，利用的就是<code>ios</code>的<code>scroll-view</code>在拉到顶部的时候还可以往下拉（橡皮筋效果），这时候我们可以把刷新的区域放在<code>scroll-view</code>可是区域上面。性能上肯定要比不断的计算高度来的要好。</p> <p>但是有两个问题：</p> <ol><li><p>不能再页面中局部使用，因为局部使用的话就需要禁用页面滚动，这也跟着禁用了ios的橡皮筋效果，从而使我们的下拉刷新不能用</p></li> <li><p>手指放开之后有个轻微的回弹效果，虽然无伤大雅，但是感觉还是挺奇怪的。</p></li></ol> <p>这种实现方式下次我也贴出来，也可以参照<a href="https://www.cnblogs.com/aaronjs/p/9982708.html" target="_blank" rel="noopener noreferrer">艾伦的博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，他说的比较详细，我也主要是参考他的代码来实现的。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/technique/weapp/issue.html" class="prev">
          小程序开发日记
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/8.e146683d.js" defer></script><script src="/blog/assets/js/app.e0c79a37.js" defer></script>
  </body>
</html>
